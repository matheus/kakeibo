<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kakeibo - The Japanese Art of Budgeting</title>
    <meta name="description" content="A simple, beautiful web app to practice the Kakeibo method, the Japanese art of mindful budgeting. Track your income, expenses, and savings goals locally and privately in your browser.">
    <meta name="keywords" content="Kakeibo, Japanese budgeting, budget app, financial planning, savings tracker, mindful spending, personal finance, kakeibo app, household ledger">
    
    <!-- PWA Manifest & Themeing -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#6d8b74">
    <link rel="apple-touch-icon" href="https://placehold.co/192x192/6d8b74/FFFFFF/png?text=家">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500&family=Inter:wght@300;400;500&display=swap" rel="stylesheet">
    <style>
        /* Custom styles for the font and theme */
        body {
            font-family: 'Inter', 'Noto Sans JP', sans-serif;
            background-color: #f4f1ea; /* An aged paper tone */
            color: #3e3c39;
        }
        .kakeibo-card {
            background-color: #ffffff;
            border: 1px solid #dcdacb;
        }
        .kakeibo-header {
            font-family: 'Noto Sans JP', sans-serif;
            color: #5a5752;
        }
        .btn-primary {
            background-color: #6d8b74; /* Sage green */
            color: #ffffff;
            transition: background-color 0.3s ease;
        }
        .btn-primary:hover {
            background-color: #5a7464;
        }
        .btn-delete {
            background-color: #d57e7e; /* Soft red */
            color: #ffffff;
            transition: background-color 0.3s ease;
        }
        .btn-delete:hover {
            background-color: #c26b6b;
        }
        .form-input {
            border-color: #dcdacb;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        .form-input:focus {
            border-color: #6d8b74;
            box-shadow: 0 0 0 2px rgba(109, 139, 116, 0.2);
            outline: none;
        }
        /* Category colors */
        .category-needs { border-left-color: #5a7464; } /* Dark green */
        .category-wants { border-left-color: #a3bfb0; } /* Light green */
        .category-culture { border-left-color: #e5b299; } /* Soft orange */
        .category-unexpected { border-left-color: #d57e7e; } /* Soft red */

        /* Smooth fade-in animation */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }
    </style>
</head>
<body class="p-4 sm:p-6 lg:p-8">
    <div class="max-w-4xl mx-auto">
        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold kakeibo-header">家計簿</h1>
            <h2 class="text-2xl font-light kakeibo-header">Kakeibo</h2>
            <p class="text-gray-500 mt-2">The Japanese art of mindful budgeting.</p>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Left Column: Controls and Form -->
            <div class="lg:col-span-1 space-y-6">
                <!-- Monthly Setup Card -->
                <div class="kakeibo-card p-6 rounded-lg shadow-sm">
                    <h3 class="text-lg font-medium kakeibo-header border-b pb-2 mb-4">Monthly Planning</h3>
                    <div class="space-y-4">
                        <div>
                            <label for="currency" class="text-sm font-medium text-gray-600">Currency</label>
                            <select id="currency" class="w-full mt-1 p-2 border form-input rounded-md bg-white">
                                <option value="USD">USD - US Dollar</option>
                                <option value="EUR">EUR - Euro</option>
                                <option value="JPY">JPY - Japanese Yen</option>
                                <option value="GBP">GBP - British Pound</option>
                                <option value="BRL">BRL - Brazilian Real</option>
                            </select>
                        </div>
                        <div>
                            <label for="income" class="text-sm font-medium text-gray-600">Monthly Income (<span id="income-currency-symbol">$</span>)</label>
                            <input type="number" id="income" placeholder="Ex: 3000.00" class="w-full mt-1 p-2 border form-input rounded-md">
                        </div>
                        <div>
                            <label for="savings-goal" class="text-sm font-medium text-gray-600">Savings Goal (<span id="savings-currency-symbol">$</span>)</label>
                            <input type="number" id="savings-goal" placeholder="Ex: 500.00" class="w-full mt-1 p-2 border form-input rounded-md">
                        </div>
                    </div>
                </div>
                
                <!-- Data Management Card -->
                <div class="kakeibo-card p-6 rounded-lg shadow-sm">
                    <h3 class="text-lg font-medium kakeibo-header border-b pb-2 mb-4">Data Management</h3>
                    <div class="space-y-3">
                        <button id="export-data" class="w-full text-center py-2 px-4 rounded-md btn-primary">Export Data</button>
                        <button id="import-data" class="w-full text-center py-2 px-4 rounded-md border border-gray-300 hover:bg-gray-50 transition-colors">Import Data</button>
                        <p class="text-xs text-gray-500 mt-3 text-center">
                            Your data is saved locally in your browser. Remember to export your data before clearing browser history.
                        </p>
                    </div>
                </div>

                <!-- Add Transaction Card -->
                <div class="kakeibo-card p-6 rounded-lg shadow-sm">
                    <h3 class="text-lg font-medium kakeibo-header border-b pb-2 mb-4">Add Expense</h3>
                    <form id="transaction-form" class="space-y-4">
                        <div>
                            <label for="description" class="text-sm font-medium text-gray-600">Description</label>
                            <input type="text" id="description" placeholder="Ex: Groceries" required class="w-full mt-1 p-2 border form-input rounded-md">
                        </div>
                        <div>
                            <label for="amount" class="text-sm font-medium text-gray-600">Amount (<span id="amount-currency-symbol">$</span>)</label>
                            <input type="number" id="amount" step="0.01" placeholder="Ex: 150.50" required class="w-full mt-1 p-2 border form-input rounded-md">
                        </div>
                        <div>
                            <label for="category" class="text-sm font-medium text-gray-600">Category</label>
                            <select id="category" required class="w-full mt-1 p-2 border form-input rounded-md bg-white">
                                <option value="needs">Survival / Needs</option>
                                <option value="wants">Optional / Wants</option>
                                <option value="culture">Culture</option>
                                <option value="unexpected">Extras / Unexpected</option>
                            </select>
                        </div>
                        <button type="submit" class="w-full btn-primary font-medium py-2 px-4 rounded-md">Add</button>
                    </form>
                </div>
            </div>

            <!-- Right Column: Summary and Transactions -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Financial Summary Card -->
                <div class="kakeibo-card p-6 rounded-lg shadow-sm">
                    <h3 class="text-lg font-medium kakeibo-header border-b pb-2 mb-4">Monthly Summary</h3>
                    <div id="summary" class="grid grid-cols-2 sm:grid-cols-4 gap-4 text-center">
                        <div>
                            <p class="text-sm text-gray-500">Income</p>
                            <p id="summary-income" class="text-xl font-semibold text-green-700">$0.00</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500">Savings Goal</p>
                            <p id="summary-savings-goal" class="text-xl font-semibold text-blue-700">$0.00</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500">Total Spent</p>
                            <p id="summary-spent" class="text-xl font-semibold text-red-600">$0.00</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500">Available</p>
                            <p id="summary-available" class="text-xl font-semibold text-gray-700">$0.00</p>
                        </div>
                    </div>
                </div>

                <!-- Transaction List Card -->
                <div class="kakeibo-card p-6 rounded-lg shadow-sm">
                    <h3 class="text-lg font-medium kakeibo-header border-b pb-2 mb-4">Expense History</h3>
                    <div id="transaction-list" class="space-y-3 max-h-96 overflow-y-auto pr-2">
                        <!-- Transactions will be inserted here -->
                        <p id="empty-state" class="text-center text-gray-500 py-4">No expenses recorded this month.</p>
                    </div>
                </div>
            </div>
        </main>

        <footer class="mt-12 pt-8 border-t border-gray-200">
            <div class="max-w-4xl mx-auto text-gray-600">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div>
                        <h3 class="text-xl font-semibold kakeibo-header mb-3">What is the Kakeibo Method?</h3>
                        <p class="text-sm mb-2">
                            Kakeibo (家計簿), meaning "household financial ledger" in Japanese, is more than just a budgeting method—it's a philosophy for mindful spending. Created in 1904, it helps you understand your relationship with money by focusing on thoughtful tracking and reflection.
                        </p>
                        <p class="text-sm">
                            The core idea is to answer four key questions at the start of each month:
                        </p>
                        <ul class="list-disc list-inside text-sm mt-2 space-y-1">
                            <li>How much money do you have available?</li>
                            <li>How much would you like to save?</li>
                            <li>How much are you spending?</li>
                            <li>How can you improve?</li>
                        </ul>
                    </div>
                    <div>
                        <h3 class="text-xl font-semibold kakeibo-header mb-3">How to Use This Application</h3>
                        <ol class="list-decimal list-inside text-sm space-y-2">
                            <li><strong>Monthly Planning:</strong> At the beginning of the month, enter your total income, set a savings goal, and choose your currency.</li>
                            <li><strong>Add Expenses:</strong> As you spend money, log each transaction with a description, amount, and one of the four Kakeibo categories.</li>
                            <li><strong>Review Your Summary:</strong> The "Monthly Summary" card gives you a real-time overview of your finances, helping you stay on track.</li>
                            <li><strong>Manage Your Data:</strong> Your data is saved only in your browser. Use the "Export Data" button regularly to create a backup JSON file. You can restore it anytime using "Import Data".</li>
                        </ol>
                    </div>
                </div>
                <div class="text-center text-xs text-gray-400 mt-8 pb-4">
                    <p>Designed with Zen principles for a calm budgeting experience.</p>
                </div>
            </div>
        </footer>

        <input type="file" id="import-file-input" class="hidden" accept=".json">
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // DOM Elements
            const currencySelector = document.getElementById('currency');
            const incomeInput = document.getElementById('income');
            const savingsGoalInput = document.getElementById('savings-goal');
            const transactionForm = document.getElementById('transaction-form');
            const descriptionInput = document.getElementById('description');
            const amountInput = document.getElementById('amount');
            const categoryInput = document.getElementById('category');
            const transactionList = document.getElementById('transaction-list');
            const emptyState = document.getElementById('empty-state');
            const exportDataBtn = document.getElementById('export-data');
            const importDataBtn = document.getElementById('import-data');
            const importFileInput = document.getElementById('import-file-input');
            
            const incomeCurrencySymbol = document.getElementById('income-currency-symbol');
            const savingsCurrencySymbol = document.getElementById('savings-currency-symbol');
            const amountCurrencySymbol = document.getElementById('amount-currency-symbol');

            const summaryIncomeEl = document.getElementById('summary-income');
            const summarySavingsGoalEl = document.getElementById('summary-savings-goal');
            const summarySpentEl = document.getElementById('summary-spent');
            const summaryAvailableEl = document.getElementById('summary-available');

            // localStorage key based on the current year and month
            const currentMonthKey = `kakeibo-${new Date().getFullYear()}-${new Date().getMonth()}`;
            
            // Application state
            let state = {
                income: 0,
                savingsGoal: 0,
                transactions: [],
                currency: 'USD'
            };

            // Utility Functions
            const formatCurrency = (value) => {
                const options = { style: 'currency', currency: state.currency };
                let locale = 'en-US';
                switch (state.currency) {
                    case 'EUR': locale = 'de-DE'; break;
                    case 'JPY': locale = 'ja-JP'; break;
                    case 'GBP': locale = 'en-GB'; break;
                    case 'BRL': locale = 'pt-BR'; break;
                }
                return new Intl.NumberFormat(locale, options).format(value);
            };

            // Data Functions
            const loadState = () => {
                const data = localStorage.getItem(currentMonthKey);
                if (data) {
                    const savedState = JSON.parse(data);
                    // Ensure currency exists in saved state, otherwise default
                    state = { ...state, ...savedState };
                    state.currency = savedState.currency || 'USD';
                }
            };

            const saveState = () => {
                localStorage.setItem(currentMonthKey, JSON.stringify(state));
            };
            
            // Render Functions
            const renderSummary = () => {
                const totalSpent = state.transactions.reduce((acc, t) => acc + t.amount, 0);
                const available = state.income - totalSpent;

                summaryIncomeEl.textContent = formatCurrency(state.income);
                summarySavingsGoalEl.textContent = formatCurrency(state.savingsGoal);
                summarySpentEl.textContent = formatCurrency(totalSpent);
                summaryAvailableEl.textContent = formatCurrency(available);
            };

            const renderTransactions = () => {
                transactionList.innerHTML = ''; // Clear the list
                if (state.transactions.length === 0) {
                    transactionList.appendChild(emptyState);
                    emptyState.style.display = 'block';
                } else {
                    emptyState.style.display = 'none';
                    // Sort transactions from newest to oldest
                    const sortedTransactions = [...state.transactions].sort((a, b) => b.id - a.id);
                    sortedTransactions.forEach(t => {
                        const transactionEl = document.createElement('div');
                        transactionEl.className = `fade-in flex justify-between items-center p-3 kakeibo-card rounded-md border-l-4 category-${t.category}`;
                        
                        transactionEl.innerHTML = `
                            <div>
                                <p class="font-medium">${t.description}</p>
                                <p class="text-sm text-gray-500">${new Date(t.id).toLocaleDateString('en-US')}</p>
                            </div>
                            <div class="text-right">
                                <p class="font-semibold">${formatCurrency(t.amount)}</p>
                                <button data-id="${t.id}" class="delete-btn text-xs text-red-500 hover:text-red-700">Delete</button>
                            </div>
                        `;
                        transactionList.appendChild(transactionEl);
                    });
                }
            };

            const updateCurrencyUI = () => {
                const symbol = new Intl.NumberFormat('en-US', { style: 'currency', currency: state.currency, currencyDisplay: 'narrowSymbol' })
                    .formatToParts(1).find(part => part.type === 'currency').value;
                
                incomeCurrencySymbol.textContent = symbol;
                savingsCurrencySymbol.textContent = symbol;
                amountCurrencySymbol.textContent = symbol;
                currencySelector.value = state.currency;
            };

            const renderAll = () => {
                incomeInput.value = state.income > 0 ? state.income : '';
                savingsGoalInput.value = state.savingsGoal > 0 ? state.savingsGoal : '';
                updateCurrencyUI();
                renderSummary();
                renderTransactions();
            };

            // Event Handlers
            const handleCurrencyChange = (e) => {
                state.currency = e.target.value;
                saveState();
                renderAll();
            };

            const handleIncomeChange = (e) => {
                state.income = parseFloat(e.target.value) || 0;
                saveState();
                renderSummary();
            };

            const handleSavingsGoalChange = (e) => {
                state.savingsGoal = parseFloat(e.target.value) || 0;
                saveState();
                renderSummary();
            };

            const handleAddTransaction = (e) => {
                e.preventDefault();
                const description = descriptionInput.value;
                const amount = parseFloat(amountInput.value);
                const category = categoryInput.value;

                if (!description || !amount || amount <= 0) {
                    console.error("Description and amount are required.");
                    return;
                }

                const newTransaction = {
                    id: Date.now(), // Using timestamp as a unique ID
                    description,
                    amount,
                    category
                };

                state.transactions.push(newTransaction);
                saveState();
                renderAll();
                
                // Reset the form
                transactionForm.reset();
            };
            
            const handleDeleteTransaction = (e) => {
                if (e.target.classList.contains('delete-btn')) {
                    const id = parseInt(e.target.dataset.id);
                    state.transactions = state.transactions.filter(t => t.id !== id);
                    saveState();
                    renderAll();
                }
            };

            const handleExportData = () => {
                const dataStr = JSON.stringify(state, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                const date = new Date();
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                link.download = `kakeibo-data-${year}-${month}.json`;
                link.href = url;
                link.click();
                URL.revokeObjectURL(url);
            };

            const handleImportClick = () => {
                importFileInput.click();
            };

            const handleImportFile = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const importedData = JSON.parse(event.target.result);
                        // Basic validation to ensure the data is in the correct format
                        if (
                            typeof importedData.income !== 'undefined' &&
                            typeof importedData.savingsGoal !== 'undefined' &&
                            Array.isArray(importedData.transactions) &&
                            typeof importedData.currency !== 'undefined'
                        ) {
                            state = importedData;
                            saveState();
                            renderAll();
                            alert('Data imported successfully!');
                        } else {
                            alert('Error: Invalid file format.');
                        }
                    } catch (error) {
                        alert('Error: Could not parse the file. Please make sure it is a valid Kakeibo JSON file.');
                        console.error("Import error:", error);
                    }
                };
                reader.readAsText(file);
                // Reset the input value to allow importing the same file again
                importFileInput.value = '';
            };

            // PWA Service Worker Registration
            const registerServiceWorker = () => {
                if ('serviceWorker' in navigator) {
                    window.addEventListener('load', () => {
                        navigator.serviceWorker.register('sw.js')
                            .then(registration => {
                                console.log('PWA Service Worker registered with scope:', registration.scope);
                            })
                            .catch(err => {
                                console.error('PWA Service Worker registration failed:', err);
                            });
                    });
                }
            };

            // Initialization
            const init = () => {
                loadState();
                renderAll();

                currencySelector.addEventListener('change', handleCurrencyChange);
                incomeInput.addEventListener('input', handleIncomeChange);
                savingsGoalInput.addEventListener('input', handleSavingsGoalChange);
                transactionForm.addEventListener('submit', handleAddTransaction);
                transactionList.addEventListener('click', handleDeleteTransaction);
                exportDataBtn.addEventListener('click', handleExportData);
                importDataBtn.addEventListener('click', handleImportClick);
                importFileInput.addEventListener('change', handleImportFile);

                registerServiceWorker(); // Register the PWA service worker
            };

            init();
        });
    </script>
</body>
</html>
